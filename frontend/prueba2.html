<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Tester Completo (Espotifai)</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 20px auto; }
    fieldset { margin-bottom: 16px; }
    input, select, button { padding: 6px; margin: 4px 0; }
    pre { background: #111; color: #0f0; padding: 12px; white-space: pre-wrap; word-wrap: break-word; }
    .row { display: grid; grid-template-columns: 140px 1fr; gap: 8px; align-items: center; }
  </style>
</head>
<body>
  <h1>Tester Completo (Login + API)</h1>

  <fieldset>
    <legend>0) Login con Google (Firebase → FastAPI)</legend>
    <button id="btnLogin">Entrar con Google</button>
    <pre id="outLogin" style="background: #333; color: white;"></pre>
  </fieldset>

  <fieldset>
    <legend>1) Config</legend>
    <div class="row"><label>API base URL</label><input id="base" value="http://localhost:8000"></div>
    <div class="row"><label>JWT (Bearer)</label><input id="jwt" placeholder="pega aquí tu token (o usa el botón de login)"></div>
  </fieldset>

  <fieldset>
    <legend>2) /media/upload</legend>
    <div class="row"><label>Archivo</label><input type="file" id="file"></div>
    <button id="btnUpload">Subir</button>
    <div class="row"><label>media_id</label><input id="mediaId" readonly></div>
    <pre id="outUpload"></pre>
  </fieldset>

  <fieldset>
    <legend>3) /media/{media_id}/convert</legend>
    <div class="row"><label>Target</label>
      <select id="target">
        <option value="mp3">mp3</option>
        <option value="mp4">mp4</option>
        <option value="hls">hls</option>
      </select>
    </div>
    <button id="btnConvert">Encolar conversión</button>
    <div class="row"><label>job_id</label><input id="jobId" readonly></div>
    <pre id="outConvert"></pre>
  </fieldset>

  <fieldset>
    <legend>4) /jobs/{job_id}/status</legend>
    <button id="btnStatus">Consultar status</button>
    <pre id="outStatus"></pre>
  </fieldset>

  <fieldset>
    <legend>5) /media/{media_id}/share</legend>
    <div class="row"><label>job_id (opcional)</label><input id="jobIdForShare" placeholder="si lo dejas vacío, toma el primero 'done'"></div>
    <button id="btnShare">Generar URL presignada</button>
    <pre id="outShare"></pre>
  </fieldset>

<script type="module">
  // 1) Importar SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  // 2) Configuración de tu app web (Firebase → Configuración del proyecto → Tus apps)
  const firebaseConfig = {
    apiKey: "AIzaSyC1C8N9YtLPakSoM-JIqpHbRcIz-wpXz2o",
    authDomain: "espotifai-81056.firebaseapp.com",
    projectId: "espotifai-81056",
    storageBucket: "espotifai-81056.firebasestorage.app",
    messagingSenderId: "116600974901",
    appId: "1:116600974901:web:d5739649bdaa970cbd4b7c",
    measurementId: "G-H9E60M6MSW"
  };

  // 3) Inicializar
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // 4) Flujo: obtener id_token de Google → enviarlo a tu backend → recibir tu JWT
  async function loginConGoogle(){
    const outLogin = document.getElementById("outLogin");
    try {
      const res = await signInWithPopup(auth, provider);
      const idToken = await res.user.getIdToken(); // ID token de Google

      const r = await fetch("http://localhost:8000/auth/google", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id_token: idToken })
      });
      const data = await r.json(); // { access_token, token_type }
      
      outLogin.textContent = JSON.stringify(data, null, 2);
      
      // --- ¡LA MEJORA! ---
      // Auto-rellenar el campo JWT del siguiente paso
      if (data.access_token) {
        document.getElementById("jwt").value = data.access_token;
      }
      
    } catch (err) {
      outLogin.textContent = "Error en el login: " + err.message;
    }
  }

  document.getElementById("btnLogin").onclick = loginConGoogle;
</script>

<script>
function authHeaders() {
  const jwt = document.getElementById('jwt').value.trim();
  // Devuelve el header de autorización si hay token
  if (jwt) {
    return { 'Authorization': 'Bearer ' + jwt };
  }
  // Devuelve objeto vacío si no hay token (para pruebas sin auth si fuesen necesarias)
  return {}; 
}

async function upload() {
  const base = document.getElementById('base').value.trim();
  const f = document.getElementById('file').files[0];
  const out = document.getElementById('outUpload');
  if (!f) { out.textContent = 'Selecciona un archivo.'; return; }
  const fd = new FormData();
  fd.append('file', f);
  
  try {
    const r = await fetch(base + '/media/upload', { method: 'POST', headers: authHeaders(), body: fd });
    const j = await r.json();
    out.textContent = JSON.stringify(j, null, 2);
    if (j.id) document.getElementById('mediaId').value = j.id;
    if (r.status >= 400) out.style.color = 'red';
    else out.style.color = '#0f0';
  } catch(err) {
    out.textContent = err.message;
    out.style.color = 'red';
  }
}

async function convert() {
  const base = document.getElementById('base').value.trim();
  const mediaId = document.getElementById('mediaId').value.trim();
  const target = document.getElementById('target').value;
  const out = document.getElementById('outConvert');
  if (!mediaId) { out.textContent = 'No hay media_id (sube un archivo primero).'; return; }
  
  try {
    const r = await fetch(`${base}/media/${mediaId}/convert`, {
      method: 'POST',
      headers: { ...authHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify({ target })
    });
    const j = await r.json();
    out.textContent = JSON.stringify(j, null, 2);
    if (j.job_id) {
      document.getElementById('jobId').value = j.job_id;
      document.getElementById('jobIdForShare').value = j.job_id;
    }
    if (r.status >= 400) out.style.color = 'red';
    else out.style.color = '#0f0';
  } catch(err) {
    out.textContent = err.message;
    out.style.color = 'red';
  }
}

async function status() {
  const base = document.getElementById('base').value.trim();
  const jobId = document.getElementById('jobId').value.trim();
  const mediaId = document.getElementById('mediaId').value.trim();
  const out = document.getElementById('outStatus');
  if (!jobId) { out.textContent = 'No hay job_id.'; return; }
  
  try {
    const url = new URL(`${base}/jobs/${jobId}/status`);
    if (mediaId) url.searchParams.set('media_id', mediaId);
    const r = await fetch(url, { headers: authHeaders() });
    const j = await r.json();
    out.textContent = JSON.stringify(j, null, 2);
    if (r.status >= 400) out.style.color = 'red';
    else out.style.color = '#0f0';
  } catch(err) {
    out.textContent = err.message;
    out.style.color = 'red';
  }
}

async function share() {
  const base = document.getElementById('base').value.trim();
  const mediaId = document.getElementById('mediaId').value.trim();
  const jobId = document.getElementById('jobIdForShare').value.trim();
  const out = document.getElementById('outShare');
  if (!mediaId) { out.textContent = 'No hay media_id.'; return; }
  
  try {
    const url = new URL(`${base}/media/${mediaId}/share`);
    if (jobId) url.searchParams.set('job_id', jobId);
    const r = await fetch(url, { headers: authHeaders() });
    const j = await r.json();
    out.textContent = JSON.stringify(j, null, 2);
    if (r.status >= 400) out.style.color = 'red';
    else out.style.color = '#0f0';
  } catch(err) {
    out.textContent = err.message;
    out.style.color = 'red';
  }
}

document.getElementById('btnUpload').onclick = upload;
document.getElementById('btnConvert').onclick = convert;
document.getElementById('btnStatus').onclick = status;
document.getElementById('btnShare').onclick = share;
</script>
</body>
</html>